---
- name: Gather EC2 node facts
  hosts: ansible-1.example.com
  connection: local
  gather_facts: no
  tasks:
  - name: Ensure instances in "{{ node_group }}" are running in region "{{ ec2_region }}"
    include_role:
      name: ec2_node_tools

- name: Confirm node startup
  hosts: all:!ansible-1.example.com
  gather_facts: no
  become: yes
  tasks:
  - name: Wait for connection...
    wait_for_connection:
      connect_timeout: 20
      sleep: 5
      delay: 5
      timeout: 300

  - name: Upgrade OS to latest packages available
    yum:
      name: '*'
      state: latest

  - name: Reboot server
    reboot:
    register: reboot_result

  - name: Wait for connection...
    wait_for_connection:
      connect_timeout: 20
      sleep: 5
      delay: 5
      timeout: 300
